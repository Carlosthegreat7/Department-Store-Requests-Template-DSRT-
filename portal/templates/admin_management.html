{% extends "base.html" %}

{% block content %}
<!-- Styles moved to main.css -->

<div class="container mgmt-container">
    <div class="row mb-4">
        <div class="col-12">
            <h1 style="font-weight: 800; letter-spacing: -1px;">SM Master Configuration</h1>
            <p class="text-muted">Maintain standard mappings for SM vendors and hierarchy.</p>
        </div>
    </div>

    <div class="search-container">
        <div class="search-box">
            <i class="fas fa-search text-muted mr-3"></i>
            <input type="text" id="mgmtSearch" class="search-input" placeholder="Search records...">
            <div style="height: 30px; width: 1px; background: #eee; margin: 0 15px;"></div>
            <select id="searchTarget" class="search-select">
                <option value="vendor">Vendors</option>
                <option value="hierarchy">Hierarchy</option>
                <option value="subclass">Subclasses</option>
            </select>
        </div>
    </div>

    <ul class="nav nav-tabs mt-4" id="smTabs" role="tablist">
        <li class="nav-item"><a class="nav-link active" data-toggle="tab" href="#vendor" role="tab"
                onclick="syncDropdown(this)">Vendors</a></li>
        <li class="nav-item"><a class="nav-link" data-toggle="tab" href="#hierarchy" role="tab"
                onclick="syncDropdown(this)">Hierarchy</a></li>
        <li class="nav-item"><a class="nav-link" data-toggle="tab" href="#subclass" role="tab"
                onclick="syncDropdown(this)">Subclasses</a></li>
    </ul>

    <div class="tab-content tab-glass mb-5">
        <div class="tab-pane fade show active" id="vendor" role="tabpanel">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h5 class="font-weight-bold mb-0">SM Vendors</h5>
                <a href="{{ url_for('vendor.add_vendor') }}" class="btn-bento-primary"
                    style="padding: 0 25px; height: 45px; font-size: 0.9rem;"><i class="fas fa-plus mr-2"></i> Add
                    Vendor</a>
            </div>
            <table class="table table-hover border-0" id="vendorTable">
                <thead class="small text-muted uppercase">
                    <tr>
                        <th class="sortable" onclick="sortTable(0, 'vendorTable')">Vendor Code</th>
                        <th class="sortable" onclick="sortTable(1, 'vendorTable')">Vendor Name</th>
                        <th class="text-right">Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for v in vendors %}
                    <tr>
                        <td class="align-middle font-weight-bold">{{ v.vendor_code }}</td>
                        <td class="align-middle">{{ v.vendor_name }}</td>
                        <td class="text-right">
                            <a href="{{ url_for('vendor.edit_vendor', code=v.vendor_code) }}"
                                class="btn-icon-hover mr-2" title="Edit"><i class="fas fa-pen"></i></a>
                            <button class="btn-icon-hover delete border-0"
                                onclick="confirmDelete('vendor', '{{ v.vendor_code }}')" title="Delete"><i
                                    class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            <div id="vendorPagination" class="pagination-container"></div>
        </div>

        <div class="tab-pane fade" id="hierarchy" role="tabpanel">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h5 class="font-weight-bold mb-0">Product Hierarchy</h5>
                <a href="{{ url_for('hierarchy.add_hierarchy') }}" class="btn-bento-primary"
                    style="padding: 0 25px; height: 45px; font-size: 0.9rem;"><i class="fas fa-plus mr-2"></i> Add
                    Brand</a>
            </div>
            <table class="table table-hover border-0" id="hierarchyTable">
                <thead class="small text-muted uppercase">
                    <tr>
                        <th class="sortable" onclick="sortTable(0, 'hierarchyTable')">Brand</th>
                        <th class="sortable" onclick="sortTable(1, 'hierarchyTable')">Group</th>
                        <th class="sortable" onclick="sortTable(2, 'hierarchyTable')">Dept</th>
                        <th class="sortable" onclick="sortTable(3, 'hierarchyTable')">Sub</th>
                        <th class="sortable" onclick="sortTable(4, 'hierarchyTable')">Class</th>
                        <th class="text-right">Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for h in hierarchies %}
                    <tr>
                        <td class="font-weight-bold align-middle">{{ h.brand_name }}</td>
                        <td class="align-middle">{{ h.product_group }}</td>
                        <td class="align-middle">{{ h.dept_code }}</td>
                        <td class="align-middle">{{ h.sub_dept_code }}</td>
                        <td class="align-middle">{{ h.class_code }}</td>
                        <td class="text-right">
                            <a href="{{ url_for('hierarchy.edit_hierarchy', code=h.brand_name) }}"
                                class="btn-icon-hover mr-2" title="Edit"><i class="fas fa-pen"></i></a>
                            <button class="btn-icon-hover delete border-0"
                                onclick="confirmDelete('hierarchy', '{{ h.brand_name }}')" title="Delete"><i
                                    class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            <div id="hierarchyPagination" class="pagination-container"></div>
        </div>

        <div class="tab-pane fade" id="subclass" role="tabpanel">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h5 class="font-weight-bold mb-0">Material Subclasses</h5>
                <a href="{{ url_for('subclass.add_subclass') }}" class="btn-bento-primary"
                    style="padding: 0 25px; height: 45px; font-size: 0.9rem;"><i class="fas fa-plus mr-2"></i>
                    Add Subclass</a>
            </div>
            <table class="table table-hover border-0" id="subclassTable">
                <thead class="small text-muted uppercase">
                    <tr>
                        <th class="sortable" onclick="sortTable(0, 'subclassTable')">Group</th>
                        <th class="sortable" onclick="sortTable(1, 'subclassTable')">Code</th>
                        <th class="sortable" onclick="sortTable(2, 'subclassTable')">Name</th>
                        <th class="text-right">Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for s in subclasses %}
                    <tr>
                        <td class="font-weight-bold align-middle">{{ s.product_group }}</td>
                        <td class="align-middle">{{ s.subclass_code }}</td>
                        <td class="align-middle">{{ s.subclass_name }}</td>
                        <td class="text-right">
                            <a href="{{ url_for('subclass.edit_subclass', group=s.product_group, code=s.subclass_code) }}"
                                class="btn-icon-hover mr-2" title="Edit"><i class="fas fa-pen"></i></a>
                            <button class="btn-icon-hover delete border-0"
                                onclick="confirmDelete('subclass', '{{ s.product_group }}', '{{ s.subclass_code }}')"
                                title="Delete"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            <div id="subclassPagination" class="pagination-container"></div>
        </div>
    </div>
</div>

<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="border-radius: 25px; border: none;">
            <div class="text-center p-4">
                <i class="fas fa-trash-alt fa-3x text-danger mb-3"></i>
                <h4 class="font-weight-bold">Delete Entry?</h4>
                <p class="text-muted">This action is permanent.</p>
                <form id="deleteForm" method="POST">
                    <button type="button" class="btn btn-light rounded-pill px-4 mr-2"
                        data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger rounded-pill px-4">Delete</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    /**
     * PAGINATION & SEARCH LOGIC
     */
    const ROWS_PER_PAGE = 10;
    const tableStates = {
        vendor: { currentPage: 1 },
        hierarchy: { currentPage: 1 },
        subclass: { currentPage: 1 }
    };

    function paginateTable(type) {
        const table = document.getElementById(`${type}Table`);
        if (!table) return;

        const searchVal = document.getElementById('mgmtSearch').value.toLowerCase();
        let allRows = Array.from(table.querySelectorAll('tbody tr'));
        let visibleRows = allRows.filter(row => row.innerText.toLowerCase().includes(searchVal));

        const totalRows = visibleRows.length;
        const totalPages = Math.ceil(totalRows / ROWS_PER_PAGE);

        if (tableStates[type].currentPage > totalPages) tableStates[type].currentPage = 1;

        const start = (tableStates[type].currentPage - 1) * ROWS_PER_PAGE;
        const end = start + ROWS_PER_PAGE;

        allRows.forEach(row => row.style.display = 'none');
        visibleRows.slice(start, end).forEach(row => row.style.display = '');

        renderPaginationUI(type, totalPages, totalRows);
    }

    function renderPaginationUI(type, totalPages, totalRows) {
        const container = document.getElementById(`${type}Pagination`);
        let html = `<span class="small text-muted">Showing <b>${totalRows}</b> results</span><div>`;

        html += `<button class="page-btn" ${tableStates[type].currentPage === 1 ? 'disabled' : ''} 
                 onclick="changePage('${type}', ${tableStates[type].currentPage - 1})"><i class="fas fa-chevron-left"></i></button>`;

        for (let i = 1; i <= totalPages; i++) {
            if (i === 1 || i === totalPages || (i >= tableStates[type].currentPage - 1 && i <= tableStates[type].currentPage + 1)) {
                html += `<button class="page-btn ${tableStates[type].currentPage === i ? 'active' : ''}" 
                         onclick="changePage('${type}', ${i})">${i}</button>`;
            } else if (i === tableStates[type].currentPage - 2 || i === tableStates[type].currentPage + 2) {
                html += `<span class="text-muted mx-1">...</span>`;
            }
        }

        html += `<button class="page-btn" ${tableStates[type].currentPage === totalPages ? 'disabled' : ''} 
                 onclick="changePage('${type}', ${tableStates[type].currentPage + 1})"><i class="fas fa-chevron-right"></i></button>`;

        html += `</div>`;
        container.innerHTML = totalPages > 1 ? html : '';
    }

    window.changePage = function (type, page) {
        tableStates[type].currentPage = page;
        paginateTable(type);
        window.scrollTo({ top: $('.mgmt-container').offset().top - 100, behavior: 'smooth' });
    }

    // --- FINAL ROBUST SYNC LOGIC ---

    // Exposed function called directly by onclick in HTML
    window.syncDropdown = function (element) {
        // slight delay to ensure tab switch logic doesn't conflict
        setTimeout(() => {
            const href = element.getAttribute('href');
            if (href) {
                const targetId = href.replace('#', '');

                // Force update
                const dropdown = document.getElementById('searchTarget');
                if (dropdown) dropdown.value = targetId;

                paginateTable(targetId);

                // Update URL State
                if (history.pushState) {
                    history.pushState(null, null, '#' + targetId);
                }
            }
        }, 50);
    };

    $(document).ready(function () {
        // Initial pagination load
        ['vendor', 'hierarchy', 'subclass'].forEach(paginateTable);

        // SEARCH INPUT TRIGGER
        $('#mgmtSearch').on('input', function () {
            ['vendor', 'hierarchy', 'subclass'].forEach(type => {
                tableStates[type].currentPage = 1;
                paginateTable(type);
            });
        });

        // 2. Dropdown Change -> Update Tab
        $('#searchTarget').on('change', function () {
            const selectedTab = this.value;
            // Activate the tab
            $(`#smTabs a[href="#${selectedTab}"]`).tab('show');
            // Update table
            paginateTable(selectedTab);
        });

        // 3. Handle Hash on Load (Recover State)
        let hash = window.location.hash;
        if (hash) {
            const cleanHash = hash.replace('#', '');
            if ($(`#smTabs a[href="#${cleanHash}"]`).length) {
                $(`#smTabs a[href="#${cleanHash}"]`).tab('show');
                $('#searchTarget').val(cleanHash);
            }
        } else {
            // Sync initial state if no hash
            const activeLink = document.querySelector('#smTabs .nav-link.active');
            if (activeLink) {
                const activeId = activeLink.getAttribute('href').replace('#', '');
                $('#searchTarget').val(activeId);
            }
        }
    });

    /**
     * SORTING LOGIC
     */
    window.sortTable = function (n, tableId) {
        var table = document.getElementById(tableId);
        var rows, switching, i, x, y, shouldSwitch, dir, switchcount = 0;
        switching = true;
        dir = "asc";
        $(table).find('th').removeClass('sort-asc sort-desc');

        while (switching) {
            switching = false;
            rows = table.rows;
            for (i = 1; i < (rows.length - 1); i++) {
                shouldSwitch = false;
                x = rows[i].getElementsByTagName("TD")[n];
                y = rows[i + 1].getElementsByTagName("TD")[n];

                let xVal = x.innerText.toLowerCase();
                let yVal = y.innerText.toLowerCase();

                if (!isNaN(parseFloat(xVal)) && !isNaN(parseFloat(yVal))) {
                    xVal = parseFloat(xVal);
                    yVal = parseFloat(yVal);
                }

                if (dir == "asc") {
                    if (xVal > yVal) { shouldSwitch = true; break; }
                } else if (dir == "desc") {
                    if (xVal < yVal) { shouldSwitch = true; break; }
                }
            }
            if (shouldSwitch) {
                rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
                switching = true;
                switchcount++;
            } else {
                if (switchcount == 0 && dir == "asc") {
                    dir = "desc";
                    switching = true;
                }
            }
        }
        table.getElementsByTagName("TH")[n].classList.add(dir === "asc" ? "sort-asc" : "sort-desc");
        paginateTable(tableId.replace('Table', ''));
    }

    window.confirmDelete = function (type, id1, id2 = null) {
        let url = `/admin/delete_${type}/${id1}`;
        if (id2) url += `/${id2}`;
        document.getElementById('deleteForm').action = url;
        $('#deleteConfirmModal').modal('show');
    }
</script>
{% endblock %}

<!-- CarlosTheGreat was here -->