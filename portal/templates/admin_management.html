{% extends "base.html" %}

{% block content %}
<style>
    .mgmt-container { padding-top: 20px; margin-bottom: 50px; }
    
    .tab-content {
        background-color: #ffffff;
        border: 1px solid #dee2e6;
        border-top: none;
        padding: 25px;
        border-bottom-left-radius: 20px;
        border-bottom-right-radius: 20px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.05);
    }

    /* --- SORTABLE HEADER STYLES --- */
    th.sortable {
        cursor: pointer;
        position: relative;
        transition: background 0.2s;
    }
    th.sortable:hover { background: #f8f9fa; }
    th.sortable::after {
        content: '\f0dc';
        font-family: 'Font Awesome 5 Free';
        font-weight: 900;
        float: right;
        color: #ccc;
        font-size: 0.8rem;
    }
    th.sort-asc::after { content: '\f0de'; color: #560bad; }
    th.sort-desc::after { content: '\f0dd'; color: #560bad; }

    .nav-tabs .nav-link { 
        border: none; color: #6c757d; font-weight: 600; padding: 12px 25px; transition: all 0.3s ease;
    }
    .nav-tabs .nav-link.active { 
        color: #560bad !important; background: transparent; border-bottom: 3px solid #560bad;
    }

    /* Premium Button */
    .btn01-hover {
        padding: 10px 25px; border-radius: 50px; color: #fff; font-weight: 600; font-size: 14px;
        background-image: linear-gradient(to right, #667eea, #764ba2, #6B8DD6, #8E37D7);
        background-size: 300% 100%; transition: all .4s ease-in-out; border: none;
        box-shadow: 0 4px 15px 0 rgba(116, 79, 168, 0.45);
    }
    .btn01-hover:hover { background-position: 100% 0; transform: translateY(-2px); color: #fff; text-decoration: none; }

    /* Action Drawer */
    .action-drawer {
        display: flex; justify-content: flex-end; align-items: center; width: 40px; height: 35px;
        background: #f8f9fa; border-radius: 20px; padding: 0 10px; margin-left: auto;
        overflow: hidden; transition: width 0.4s ease; border: 1px solid rgba(0,0,0,0.05);
    }
    .action-drawer:hover { width: 100px; background: #fff; }
    .action-btn { background: none; border: none; padding: 5px; opacity: 0.3; transition: 0.3s; }
    .action-drawer:hover .action-btn { opacity: 1; }
    .btn-edit { color: #560bad; }
    .btn-delete { color: #f72585; margin-left: 10px; }
</style>

<div class="container mgmt-container">
    <div class="row mb-4">
        <div class="col-12">
            <h1 style="font-weight: 800; letter-spacing: -1px;">SM Master Configuration</h1>
            <p class="text-muted">Click any table header to sort ascending or descending.</p>
        </div>
    </div>

    <ul class="nav nav-tabs" id="smTabs" role="tablist">
        <li class="nav-item"><a class="nav-link active" data-toggle="tab" href="#vendor">Vendors</a></li>
        <li class="nav-item"><a class="nav-link" data-toggle="tab" href="#hierarchy">Hierarchy</a></li>
        <li class="nav-item"><a class="nav-link" data-toggle="tab" href="#subclass">Subclasses</a></li>
    </ul>

    <div class="tab-content mb-5">
        <div class="tab-pane fade show active" id="vendor">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h5 class="font-weight-bold mb-0">SM Vendors</h5>
                <a href="{{ url_for('vendor.add_vendor') }}" class="btn01-hover"><i class="fas fa-plus mr-2"></i> Add Vendor</a>
            </div>
            <table class="table table-hover border-0" id="vendorTable">
                <thead class="small text-muted uppercase">
                    <tr>
                        <th class="sortable" onclick="sortTable(0, 'vendorTable')">Vendor Code</th>
                        <th class="sortable" onclick="sortTable(1, 'vendorTable')">Vendor Name</th>
                        <th class="text-right">Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for v in vendors %}
                    <tr>
                        <td class="align-middle font-weight-bold">{{ v.vendor_code }}</td>
                        <td class="align-middle">{{ v.vendor_name }}</td>
                        <td class="text-right">
                            <div class="action-drawer">
                                <a href="{{ url_for('vendor.edit_vendor', code=v.vendor_code) }}" class="action-btn btn-edit"><i class="fas fa-edit"></i></a>
                                <button class="action-btn btn-delete" onclick="confirmDelete('vendor', '{{ v.vendor_code }}')"><i class="fas fa-trash"></i></button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="tab-pane fade" id="hierarchy">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h5 class="font-weight-bold mb-0">Product Hierarchy</h5>
                <a href="{{ url_for('hierarchy.add_hierarchy') }}" class="btn01-hover"><i class="fas fa-plus mr-2"></i> Add Brand</a>
            </div>
            <table class="table table-hover border-0" id="hierarchyTable">
                <thead class="small text-muted uppercase">
                    <tr>
                        <th class="sortable" onclick="sortTable(0, 'hierarchyTable')">Brand</th>
                        <th class="sortable" onclick="sortTable(1, 'hierarchyTable')">Group</th>
                        <th class="sortable" onclick="sortTable(2, 'hierarchyTable')">Dept</th>
                        <th class="sortable" onclick="sortTable(3, 'hierarchyTable')">Sub</th>
                        <th class="sortable" onclick="sortTable(4, 'hierarchyTable')">Class</th>
                        <th class="text-right">Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for h in hierarchies %}
                    <tr>
                        <td class="font-weight-bold align-middle">{{ h.brand_name }}</td>
                        <td class="align-middle">{{ h.product_group }}</td>
                        <td class="align-middle">{{ h.dept_code }}</td>
                        <td class="align-middle">{{ h.sub_dept_code }}</td>
                        <td class="align-middle">{{ h.class_code }}</td>
                        <td class="text-right">
                            <div class="action-drawer">
                                <a href="{{ url_for('hierarchy.edit_hierarchy', code=h.brand_name) }}" class="action-btn btn-edit"><i class="fas fa-edit"></i></a>
                                <button class="action-btn btn-delete" onclick="confirmDelete('hierarchy', '{{ h.brand_name }}')"><i class="fas fa-trash"></i></button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="tab-pane fade" id="subclass">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h5 class="font-weight-bold mb-0">Material Subclasses</h5>
                <a href="{{ url_for('subclass.add_subclass') }}" class="btn01-hover"><i class="fas fa-plus mr-2"></i> Add Subclass</a>
            </div>
            <table class="table table-hover border-0" id="subclassTable">
                <thead class="small text-muted uppercase">
                    <tr>
                        <th class="sortable" onclick="sortTable(0, 'subclassTable')">Group</th>
                        <th class="sortable" onclick="sortTable(1, 'subclassTable')">Code</th>
                        <th class="sortable" onclick="sortTable(2, 'subclassTable')">Name</th>
                        <th class="text-right">Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for s in subclasses %}
                    <tr>
                        <td class="font-weight-bold align-middle">{{ s.product_group }}</td>
                        <td class="align-middle">{{ s.subclass_code }}</td>
                        <td class="align-middle">{{ s.subclass_name }}</td>
                        <td class="text-right">
                            <div class="action-drawer">
                                <a href="{{ url_for('subclass.edit_subclass', group=s.product_group, code=s.subclass_code) }}" class="action-btn btn-edit"><i class="fas fa-edit"></i></a>
                                <button class="action-btn btn-delete" onclick="confirmDelete('subclass', '{{ s.product_group }}', '{{ s.subclass_code }}')"><i class="fas fa-trash"></i></button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="border-radius: 25px; border: none;">
            <div class="text-center p-4">
                <i class="fas fa-trash-alt fa-3x text-danger mb-3"></i>
                <h4 class="font-weight-bold">Delete Entry?</h4>
                <p class="text-muted">This action is permanent.</p>
                <form id="deleteForm" method="POST">
                    <button type="button" class="btn btn-light rounded-pill px-4 mr-2" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger rounded-pill px-4">Delete</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
    /**
     * SORTING LOGIC
     * Sorts table columns in Ascending/Descending order.
     */
    function sortTable(n, tableId) {
        var table = document.getElementById(tableId);
        var rows, switching, i, x, y, shouldSwitch, dir, switchcount = 0;
        switching = true;
        dir = "asc"; 
        
        // Remove existing sort classes
        $(table).find('th').removeClass('sort-asc sort-desc');

        while (switching) {
            switching = false;
            rows = table.rows;
            for (i = 1; i < (rows.length - 1); i++) {
                shouldSwitch = false;
                x = rows[i].getElementsByTagName("TD")[n];
                y = rows[i + 1].getElementsByTagName("TD")[n];

                let xVal = x.innerText.toLowerCase();
                let yVal = y.innerText.toLowerCase();

                // Check if numeric
                if (!isNaN(parseFloat(xVal)) && !isNaN(parseFloat(yVal))) {
                    xVal = parseFloat(xVal);
                    yVal = parseFloat(yVal);
                }

                if (dir == "asc") {
                    if (xVal > yVal) { shouldSwitch = true; break; }
                } else if (dir == "desc") {
                    if (xVal < yVal) { shouldSwitch = true; break; }
                }
            }
            if (shouldSwitch) {
                rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
                switching = true;
                switchcount++;
            } else {
                if (switchcount == 0 && dir == "asc") {
                    dir = "desc";
                    switching = true;
                }
            }
        }
        
        // Add visual indicator class
        const header = table.getElementsByTagName("TH")[n];
        header.classList.add(dir === "asc" ? "sort-asc" : "sort-desc");
    }

    // Persist Tab across redirects
    $(document).ready(function() {
        let hash = window.location.hash;
        if (hash) { $(`.nav-tabs a[href="${hash}"]`).tab('show'); }
        $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
            window.history.replaceState(null, null, $(e.target).attr("href"));
        });
    });

    function confirmDelete(type, id1, id2 = null) {
        let url = `/admin/delete_${type}/${id1}`;
        if(id2) url += `/${id2}`;
        document.getElementById('deleteForm').action = url;
        $('#deleteConfirmModal').modal('show');
    }
</script>
{% endblock %}