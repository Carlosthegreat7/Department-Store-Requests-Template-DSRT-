{% extends "base.html" %}

{% block content %}
<style>
    /* --- BENTO PAGE STYLES --- */
    .mgmt-container { padding-top: 20px; margin-bottom: 50px; }
    
    .tab-content {
        background-color: #ffffff;
        border: 1px solid #dee2e6;
        border-top: none;
        padding: 25px;
        border-bottom-left-radius: 20px;
        border-bottom-right-radius: 20px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.05);
    }

    /* --- SORTABLE HEADER STYLES --- */
    th.sortable {
        cursor: pointer;
        position: relative;
        transition: background 0.2s;
    }
    th.sortable:hover { background: #f8f9fa; }
    th.sortable::after {
        content: '\f0dc';
        font-family: 'Font Awesome 5 Free';
        font-weight: 900;
        float: right;
        color: #ccc;
        font-size: 0.8rem;
    }
    th.sort-asc::after { content: '\f0de'; color: #560bad; }
    th.sort-desc::after { content: '\f0dd'; color: #560bad; }

    /* --- PAGINATION STYLES --- */
    .pagination-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 30px;
        padding-top: 20px;
        border-top: 1px solid #eee;
    }
    .page-btn {
        padding: 8px 18px;
        border-radius: 50px;
        border: 1px solid #dee2e6;
        background: white;
        color: #6c757d;
        font-weight: 600;
        transition: all 0.3s ease;
        margin: 0 5px;
    }
    .page-btn:hover:not(:disabled) {
        background: #f8f9fa;
        color: #560bad;
        border-color: #560bad;
    }
    .page-btn.active {
        background: #560bad;
        color: white;
        border-color: #560bad;
    }
    .page-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .nav-tabs .nav-link { 
        border: none; color: #6c757d; font-weight: 600; padding: 12px 25px; transition: all 0.3s ease;
    }
    .nav-tabs .nav-link.active { 
        color: #560bad !important; background: transparent; border-bottom: 3px solid #560bad;
    }

    .search-container {
        position: sticky; top: 80px; z-index: 1000;
        background: #f8f9fa; padding: 15px 0;
    }
    .bento-tile {
        background: white; border-radius: 20px; padding: 20px; border: 1px solid rgba(0,0,0,0.05);
    }

    /* Premium Button */
    .btn01-hover {
        padding: 10px 25px; border-radius: 50px; color: #fff; font-weight: 600; font-size: 14px;
        background-image: linear-gradient(to right, #667eea, #764ba2, #6B8DD6, #8E37D7);
        background-size: 300% 100%; transition: all .4s ease-in-out; border: none;
        box-shadow: 0 4px 15px 0 rgba(116, 79, 168, 0.45);
    }
    .btn01-hover:hover { background-position: 100% 0; transform: translateY(-2px); color: #fff; text-decoration: none; }

    /* Action Drawer */
    .action-drawer {
        display: flex; justify-content: flex-end; align-items: center; width: 40px; height: 35px;
        background: #f8f9fa; border-radius: 20px; padding: 0 10px; margin-left: auto;
        overflow: hidden; transition: width 0.4s ease; border: 1px solid rgba(0,0,0,0.05);
    }
    .action-drawer:hover { width: 100px; background: #fff; }
    .action-btn { background: none; border: none; padding: 5px; opacity: 0.3; transition: 0.3s; }
    .action-drawer:hover .action-btn { opacity: 1; }
    .btn-edit { color: #560bad; }
    .btn-delete { color: #f72585; margin-left: 10px; }
</style>

<div class="container mgmt-container">
    <div class="row mb-4">
        <div class="col-12">
            <h1 style="font-weight: 800; letter-spacing: -1px;">SM Master Configuration</h1>
            <p class="text-muted">Maintain standard mappings for SM vendors and hierarchy.</p>
        </div>
    </div>

    <div class="search-container">
        <div class="bento-tile shadow-sm d-flex align-items-center">
            <div class="input-group" style="max-width: 550px;">
                <div class="input-group-prepend">
                    <span class="input-group-text bg-white border-right-0" style="border-radius: 50px 0 0 50px;">
                        <i class="fas fa-search text-muted"></i>
                    </span>
                </div>
                <input type="text" id="mgmtSearch" class="form-control border-left-0" placeholder="Type to search..." style="border-radius: 0 50px 50px 0;">
            </div>
            <select id="searchTarget" class="form-control ml-3 rounded-pill" style="max-width: 180px;">
                <option value="vendor">Vendors</option>
                <option value="hierarchy">Hierarchy</option>
                <option value="subclass">Subclasses</option>
            </select>
        </div>
    </div>

    <ul class="nav nav-tabs mt-4" id="smTabs" role="tablist">
        <li class="nav-item"><a class="nav-link active" data-toggle="tab" href="#vendor" role="tab">Vendors</a></li>
        <li class="nav-item"><a class="nav-link" data-toggle="tab" href="#hierarchy" role="tab">Hierarchy</a></li>
        <li class="nav-item"><a class="nav-link" data-toggle="tab" href="#subclass" role="tab">Subclasses</a></li>
    </ul>

    <div class="tab-content mb-5">
        <div class="tab-pane fade show active" id="vendor" role="tabpanel">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h5 class="font-weight-bold mb-0">SM Vendors</h5>
                <a href="{{ url_for('vendor.add_vendor') }}" class="btn01-hover"><i class="fas fa-plus mr-2"></i> Add Vendor</a>
            </div>
            <table class="table table-hover border-0" id="vendorTable">
                <thead class="small text-muted uppercase">
                    <tr>
                        <th class="sortable" onclick="sortTable(0, 'vendorTable')">Vendor Code</th>
                        <th class="sortable" onclick="sortTable(1, 'vendorTable')">Vendor Name</th>
                        <th class="text-right">Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for v in vendors %}
                    <tr>
                        <td class="align-middle font-weight-bold">{{ v.vendor_code }}</td>
                        <td class="align-middle">{{ v.vendor_name }}</td>
                        <td class="text-right">
                            <div class="action-drawer">
                                <a href="{{ url_for('vendor.edit_vendor', code=v.vendor_code) }}" class="action-btn btn-edit"><i class="fas fa-edit"></i></a>
                                <button class="action-btn btn-delete" onclick="confirmDelete('vendor', '{{ v.vendor_code }}')"><i class="fas fa-trash"></i></button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            <div id="vendorPagination" class="pagination-container"></div>
        </div>

        <div class="tab-pane fade" id="hierarchy" role="tabpanel">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h5 class="font-weight-bold mb-0">Product Hierarchy</h5>
                <a href="{{ url_for('hierarchy.add_hierarchy') }}" class="btn01-hover"><i class="fas fa-plus mr-2"></i> Add Brand</a>
            </div>
            <table class="table table-hover border-0" id="hierarchyTable">
                <thead class="small text-muted uppercase">
                    <tr>
                        <th class="sortable" onclick="sortTable(0, 'hierarchyTable')">Brand</th>
                        <th class="sortable" onclick="sortTable(1, 'hierarchyTable')">Group</th>
                        <th class="sortable" onclick="sortTable(2, 'hierarchyTable')">Dept</th>
                        <th class="sortable" onclick="sortTable(3, 'hierarchyTable')">Sub</th>
                        <th class="sortable" onclick="sortTable(4, 'hierarchyTable')">Class</th>
                        <th class="text-right">Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for h in hierarchies %}
                    <tr>
                        <td class="font-weight-bold align-middle">{{ h.brand_name }}</td>
                        <td class="align-middle">{{ h.product_group }}</td>
                        <td class="align-middle">{{ h.dept_code }}</td>
                        <td class="align-middle">{{ h.sub_dept_code }}</td>
                        <td class="align-middle">{{ h.class_code }}</td>
                        <td class="text-right">
                            <div class="action-drawer">
                                <a href="{{ url_for('hierarchy.edit_hierarchy', code=h.brand_name) }}" class="action-btn btn-edit"><i class="fas fa-edit"></i></a>
                                <button class="action-btn btn-delete" onclick="confirmDelete('hierarchy', '{{ h.brand_name }}')"><i class="fas fa-trash"></i></button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            <div id="hierarchyPagination" class="pagination-container"></div>
        </div>

        <div class="tab-pane fade" id="subclass" role="tabpanel">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h5 class="font-weight-bold mb-0">Material Subclasses</h5>
                <a href="{{ url_for('subclass.add_subclass') }}" class="btn01-hover"><i class="fas fa-plus mr-2"></i> Add Subclass</a>
            </div>
            <table class="table table-hover border-0" id="subclassTable">
                <thead class="small text-muted uppercase">
                    <tr>
                        <th class="sortable" onclick="sortTable(0, 'subclassTable')">Group</th>
                        <th class="sortable" onclick="sortTable(1, 'subclassTable')">Code</th>
                        <th class="sortable" onclick="sortTable(2, 'subclassTable')">Name</th>
                        <th class="text-right">Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for s in subclasses %}
                    <tr>
                        <td class="font-weight-bold align-middle">{{ s.product_group }}</td>
                        <td class="align-middle">{{ s.subclass_code }}</td>
                        <td class="align-middle">{{ s.subclass_name }}</td>
                        <td class="text-right">
                            <div class="action-drawer">
                                <a href="{{ url_for('subclass.edit_subclass', group=s.product_group, code=s.subclass_code) }}" class="action-btn btn-edit"><i class="fas fa-edit"></i></a>
                                <button class="action-btn btn-delete" onclick="confirmDelete('subclass', '{{ s.product_group }}', '{{ s.subclass_code }}')"><i class="fas fa-trash"></i></button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            <div id="subclassPagination" class="pagination-container"></div>
        </div>
    </div>
</div>

<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="border-radius: 25px; border: none;">
            <div class="text-center p-4">
                <i class="fas fa-trash-alt fa-3x text-danger mb-3"></i>
                <h4 class="font-weight-bold">Delete Entry?</h4>
                <p class="text-muted">This action is permanent.</p>
                <form id="deleteForm" method="POST">
                    <button type="button" class="btn btn-light rounded-pill px-4 mr-2" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger rounded-pill px-4">Delete</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
    /**
     * PAGINATION ENGINE
     * Handles dynamic paging for tables with scroll-to-top logic.
     */
    const ROWS_PER_PAGE = 10;
    const tableStates = {
        vendor: { currentPage: 1 },
        hierarchy: { currentPage: 1 },
        subclass: { currentPage: 1 }
    };

    function paginateTable(type) {
        const table = document.getElementById(`${type}Table`);
        const searchVal = document.getElementById('mgmtSearch').value.toLowerCase();
        
        // Filter rows based on search first
        let allRows = Array.from(table.querySelectorAll('tbody tr'));
        let visibleRows = allRows.filter(row => row.innerText.toLowerCase().includes(searchVal));
        
        const totalRows = visibleRows.length;
        const totalPages = Math.ceil(totalRows / ROWS_PER_PAGE);
        
        // Reset to page 1 if current page is out of bounds
        if (tableStates[type].currentPage > totalPages) tableStates[type].currentPage = 1;
        if (tableStates[type].currentPage < 1) tableStates[type].currentPage = 1;

        const start = (tableStates[type].currentPage - 1) * ROWS_PER_PAGE;
        const end = start + ROWS_PER_PAGE;

        // Hide all, show only current page
        allRows.forEach(row => row.style.display = 'none');
        visibleRows.slice(start, end).forEach(row => row.style.display = '');

        renderPaginationUI(type, totalPages, totalRows);
    }

    function renderPaginationUI(type, totalPages, totalRows) {
        const container = document.getElementById(`${type}Pagination`);
        let html = `<span class="small text-muted">Showing <b>${totalRows}</b> results</span><div>`;
        
        // Previous Button
        html += `<button class="page-btn" ${tableStates[type].currentPage === 1 ? 'disabled' : ''} 
                 onclick="changePage('${type}', ${tableStates[type].currentPage - 1})"><i class="fas fa-chevron-left"></i></button>`;

        // Page Numbers (limited)
        for(let i=1; i <= totalPages; i++) {
            if(i === 1 || i === totalPages || (i >= tableStates[type].currentPage - 1 && i <= tableStates[type].currentPage + 1)) {
                html += `<button class="page-btn ${tableStates[type].currentPage === i ? 'active' : ''}" 
                         onclick="changePage('${type}', ${i})">${i}</button>`;
            } else if (i === tableStates[type].currentPage - 2 || i === tableStates[type].currentPage + 2) {
                html += `<span class="text-muted mx-1">...</span>`;
            }
        }

        // Next Button
        html += `<button class="page-btn" ${tableStates[type].currentPage === totalPages ? 'disabled' : ''} 
                 onclick="changePage('${type}', ${tableStates[type].currentPage + 1})"><i class="fas fa-chevron-right"></i></button>`;
        
        html += `</div>`;
        container.innerHTML = totalPages > 1 ? html : '';
    }

    /**
     * SMOOTH SCROLL PAGE CHANGE
     */
    window.changePage = function(type, page) {
        tableStates[type].currentPage = page;
        paginateTable(type);
        
        // Smoothly scroll to top of management section
        window.scrollTo({
            top: $('.mgmt-container').offset().top - 100,
            behavior: 'smooth'
        });
    }

    $(document).ready(function() {
        // Initial pagination
        ['vendor', 'hierarchy', 'subclass'].forEach(paginateTable);

        // Search integration
        $('#mgmtSearch').on('input', function() {
            ['vendor', 'hierarchy', 'subclass'].forEach(type => {
                tableStates[type].currentPage = 1;
                paginateTable(type);
            });
        });

        // Tab Sync
        $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
            const target = $(e.target).attr("href").replace('#', '');
            document.getElementById('searchTarget').value = target;
            paginateTable(target);
            window.history.replaceState(null, null, $(e.target).attr("href"));
        });

        // Dropdown Sync
        $('#searchTarget').on('change', function() {
            $(`#smTabs a[href="#${this.value}"]`).tab('show');
        });

        // Recover tab from hash
        let hash = window.location.hash;
        if (hash) {
            $(`.nav-tabs a[href="${hash}"]`).tab('show');
            document.getElementById('searchTarget').value = hash.replace('#', '');
        }
    });

    /**
     * SORTING LOGIC
     */
    window.sortTable = function(n, tableId) {
        var table = document.getElementById(tableId);
        var rows, switching, i, x, y, shouldSwitch, dir, switchcount = 0;
        switching = true;
        dir = "asc"; 
        $(table).find('th').removeClass('sort-asc sort-desc');

        while (switching) {
            switching = false;
            rows = table.rows;
            for (i = 1; i < (rows.length - 1); i++) {
                shouldSwitch = false;
                x = rows[i].getElementsByTagName("TD")[n];
                y = rows[i + 1].getElementsByTagName("TD")[n];

                let xVal = x.innerText.toLowerCase();
                let yVal = y.innerText.toLowerCase();

                if (!isNaN(parseFloat(xVal)) && !isNaN(parseFloat(yVal))) {
                    xVal = parseFloat(xVal);
                    yVal = parseFloat(yVal);
                }

                if (dir == "asc") {
                    if (xVal > yVal) { shouldSwitch = true; break; }
                } else if (dir == "desc") {
                    if (xVal < yVal) { shouldSwitch = true; break; }
                }
            }
            if (shouldSwitch) {
                rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
                switching = true;
                switchcount++;
            } else {
                if (switchcount == 0 && dir == "asc") {
                    dir = "desc";
                    switching = true;
                }
            }
        }
        table.getElementsByTagName("TH")[n].classList.add(dir === "asc" ? "sort-asc" : "sort-desc");
        
        // Re-paginate after sorting
        paginateTable(tableId.replace('Table', ''));
    }

    window.confirmDelete = function(type, id1, id2 = null) {
        let url = `/admin/delete_${type}/${id1}`;
        if(id2) url += `/${id2}`;
        document.getElementById('deleteForm').action = url;
        $('#deleteConfirmModal').modal('show');
    }
</script>
{% endblock %}