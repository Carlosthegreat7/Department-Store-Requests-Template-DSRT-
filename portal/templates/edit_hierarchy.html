{% extends "base.html" %}

{% block content %}
<style>
    .edit-container { 
        max-width: 800px; 
        margin: 0 auto; 
        padding-top: 30px; 
    }

    /* --- GLASSMOPHISM HEADER --- */
    .glass-header {
        height: 120px;
        background: #4361ee;
        border-radius: 28px;
        position: relative;
        overflow: hidden;
        display: flex;
        align-items: center;
        padding: 0 40px;
        color: white;
        margin-bottom: 30px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 15px 35px rgba(67, 97, 238, 0.2);
    }

    .glass-header::before {
        content: "";
        position: absolute;
        inset: 0;
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        z-index: 1;
    }

    .header-text { z-index: 2; }
    .header-text h2 { font-weight: 800; letter-spacing: -1px; margin-bottom: 0; }

    /* --- BENTO FORM CONTROLS --- */
    .form-control-bento {
        border-radius: 50px !important;
        padding: 12px 25px !important;
        border: 1px solid #e9ecef !important;
        background-color: #f8f9fa !important;
        color: #2d3436 !important;
        transition: all 0.3s ease;
    }

    .form-control-bento:focus {
        background-color: #fff !important;
        border-color: #4361ee !important;
        box-shadow: 0 0 0 0.2rem rgba(67, 97, 238, 0.15) !important;
        outline: none;
    }

    .form-control-bento.is-invalid {
        border-color: #f72585 !important;
        background-color: rgba(247, 37, 133, 0.05) !important;
    }

    .btn-save {
        background-image: linear-gradient(to right, #667eea, #764ba2, #6B8DD6, #8E37D7);
        background-size: 300% 100%;
        color: #fff !important;
        border: none;
        border-radius: 50px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 1px;
        transition: all 0.4s ease-in-out;
        box-shadow: 0 4px 15px 0 rgba(116, 79, 168, 0.45);
    }

    .btn-save:hover {
        background-position: 100% 0;
        transform: translateY(-2px);
    }

    .modal-glass {
        backdrop-filter: blur(10px);
        background: rgba(255,255,255,0.1);
    }
    .modal-content-bento {
        border-radius: 30px;
        border: none;
        padding: 20px;
    }

    .input-hint {
        font-size: 0.7rem;
        margin-top: 5px;
        color: #6c757d;
        display: block;
    }
</style>

<div class="container edit-container">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <a href="{{ url_for('admin_management', _anchor='hierarchy') }}" class="btn btn-sm btn-light rounded-pill px-3 shadow-sm text-muted">
            <i class="fas fa-arrow-left mr-1"></i> BACK TO DASHBOARD
        </a>
    </div>

    <div class="glass-header shadow-sm">
        <div class="header-text">
            <h2><i class="fas fa-edit mr-3"></i>Edit Hierarchy</h2>
        </div>
    </div>

    <div class="bento-tile shadow-lg bg-white p-5" style="border-radius: 35px;">
        <form id="editHierarchyForm" action="{{ url_for('hierarchy.edit_hierarchy', code=hierarchy.brand_name) }}" method="POST" autocomplete="off">
            <div class="row">
                <div class="col-md-6 mb-4">
                    <label class="small font-weight-bold text-muted uppercase ml-2">Brand Name</label>
                    <input type="text" name="brand_name" class="form-control form-control-bento text-uppercase" 
                           value="{{ hierarchy.brand_name }}" required>
                    <span class="input-hint ml-3">Full display name (e.g. GIORDANO)</span>
                </div>
                <div class="col-md-6 mb-4">
                    <label class="small font-weight-bold text-muted uppercase ml-2">Product Group</label>
                    <input type="text" name="product_group" class="form-control form-control-bento text-uppercase" 
                           value="{{ hierarchy.product_group }}" maxlength="20" required>
                    <span class="input-hint ml-3">Unique ID (e.g. GIORD)</span>
                </div>
            </div>

            <div class="row">
                <div class="col-md-4 mb-4">
                    <label class="small font-weight-bold text-muted uppercase ml-2">Dept Code</label>
                    <input type="text" name="dept_code" class="form-control form-control-bento num-only" 
                           value="{{ hierarchy.dept_code }}" maxlength="3" pattern="\d{3}" required>
                    <span class="input-hint ml-3">Exactly 3 digits</span>
                </div>
                <div class="col-md-4 mb-4">
                    <label class="small font-weight-bold text-muted uppercase ml-2">Sub-Dept Code</label>
                    <input type="text" name="sub_dept_code" class="form-control form-control-bento num-only" 
                           value="{{ hierarchy.sub_dept_code }}" maxlength="3" pattern="\d{3}" required>
                    <span class="input-hint ml-3">Exactly 3 digits</span>
                </div>
                <div class="col-md-4 mb-4">
                    <label class="small font-weight-bold text-muted uppercase ml-2">Class Code</label>
                    <input type="text" name="class_code" class="form-control form-control-bento num-only" 
                           value="{{ hierarchy.class_code }}" maxlength="3" pattern="\d{3}" required>
                    <span class="input-hint ml-3">Exactly 3 digits</span>
                </div>
            </div>

            <hr class="my-4 opacity-25">

            <div class="d-flex justify-content-between">
                <a href="{{ url_for('admin_management', _anchor='hierarchy') }}" class="btn btn-light rounded-pill px-4 font-weight-bold text-muted">CANCEL</a>
                <button type="button" class="btn btn-save px-5 py-2" onclick="validateAndShowModal()">
                    <i class="fas fa-save mr-2"></i> Update Hierarchy
                </button>
            </div>
        </form>
    </div>
</div>

<div class="modal fade modal-glass" id="confirmEditModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content modal-content-bento bento-tile shadow-2xl bg-white">
            <div class="text-center p-4">
                <div class="mb-4">
                    <i class="fas fa-exclamation-triangle fa-4x text-info" style="opacity: 0.8;"></i>
                </div>
                <h3 class="font-weight-bold mb-3">Save Changes?</h3>
                <p class="text-muted px-3">Are you sure you want to update this hierarchy entry? This may affect filename generation for future templates.</p>
                
                <div class="summary-preview text-left bg-light p-3 my-3" style="border-radius: 20px; font-size: 0.9rem;">
                    <strong>Updated PG:</strong> <span id="prevPG">--</span><br>
                    <strong>Updated Codes:</strong> <span id="prevCodes">--</span>
                </div>

                <div class="d-flex justify-content-center mt-4">
                    <button type="button" class="btn btn-light rounded-pill px-4 mr-3" data-dismiss="modal">No, Cancel</button>
                    <button type="button" class="btn btn-primary rounded-pill px-4" onclick="submitForm()">Yes, Confirm</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(document).ready(function() {
        // --- 1. NUMERIC ONLY GUARD ---
        $('.num-only').on('input', function() {
            this.value = this.value.replace(/[^0-9]/g, '');
        });

        // --- 2. UPPERCASE GUARD ---
        $('input[type="text"]').on('input', function() {
            this.value = this.value.toUpperCase();
        });
    });

    // --- BROWSER NAVIGATION REFRESH FIX ---
    window.addEventListener('pageshow', function(event) {
        const navEntries = performance.getEntriesByType("navigation");
        if (event.persisted || (navEntries.length > 0 && navEntries[0].type === 'back_forward')) {
            window.location.reload(); 
        }
    });

    function validateAndShowModal() {
        const form = document.getElementById('editHierarchyForm');
        let isValid = true;
        
        const inputs = form.querySelectorAll('input[required]');
        inputs.forEach(input => {
            input.classList.remove('is-invalid');
            // Check empty or regex pattern (3 digits)
            if (!input.value.trim() || (input.pattern && !new RegExp(input.pattern).test(input.value))) {
                input.classList.add('is-invalid');
                isValid = false;
            }
        });

        if (isValid) {
            // Populate Preview Data for the Modal
            $('#prevPG').text($('input[name="product_group"]').val());
            $('#prevCodes').text(
                $('input[name="dept_code"]').val() + '.' + 
                $('input[name="sub_dept_code"]').val() + '.' + 
                $('input[name="class_code"]').val()
            );
            $('#confirmEditModal').modal('show');
        } else {
            const saveBtn = $('.btn-save');
            saveBtn.addClass('animate__animated animate__shakeX');
            setTimeout(() => saveBtn.removeClass('animate__animated animate__shakeX'), 500);
        }
    }

    function submitForm() {
        document.getElementById('editHierarchyForm').submit();
    }
</script>
{% endblock %}