{% extends "base.html" %}

{% block content %}
<style>
    .edit-container { max-width: 600px; margin: 0 auto; padding-top: 30px; }

    /* --- GLASSMOPHISM HEADER --- */
    .glass-header {
        height: 120px;
        background: #4361ee;
        border-radius: 28px;
        position: relative;
        overflow: hidden;
        display: flex;
        align-items: center;
        padding: 0 40px;
        color: white;
        margin-bottom: 30px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 15px 35px rgba(67, 97, 238, 0.2);
    }

    .glass-header::before {
        content: "";
        position: absolute;
        inset: 0;
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        z-index: 1;
    }

    .header-text { z-index: 2; }
    .header-text h2 { font-weight: 800; letter-spacing: -1px; margin-bottom: 0; }

    /* --- BENTO FORM CONTROLS --- */
    .form-control-bento {
        border-radius: 50px !important;
        padding: 12px 25px !important;
        border: 1px solid #e9ecef !important;
        background-color: #f8f9fa !important;
        color: #2d3436 !important;
        transition: all 0.3s ease;
    }

    .form-control-bento:focus {
        background-color: #fff !important;
        border-color: var(--accent-purple) !important;
        box-shadow: 0 0 0 0.2rem rgba(86, 11, 173, 0.15) !important;
    }

    .btn-save {
        background-image: linear-gradient(to right, #667eea, #764ba2, #6B8DD6, #8E37D7);
        background-size: 300% 100%;
        color: #fff !important;
        border: none;
        border-radius: 50px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 1px;
        transition: all 0.4s ease-in-out;
        box-shadow: 0 4px 15px 0 rgba(116, 79, 168, 0.45);
    }

    .btn-save:hover {
        background-position: 100% 0;
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(86, 10, 173, 0.3);
    }

    .breadcrumb-bento { background: transparent; padding: 0; margin-bottom: 20px; font-size: 0.85rem; }
    .breadcrumb-bento a { color: var(--accent-purple); font-weight: 600; text-decoration: none; }

    .modal-glass { backdrop-filter: blur(10px); background: rgba(255,255,255,0.1); }
    .modal-content-bento { border-radius: 30px; border: none; padding: 20px; }
</style>

<div class="container edit-container">
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb breadcrumb-bento">
        <li class="breadcrumb-item"><a href="{{ url_for('admin_management') }}"><i class="fas fa-arrow-left mr-1"></i> Management</a></li>
        <li class="breadcrumb-item active text-muted">Edit Vendor</li>
      </ol>
    </nav>

    <div class="glass-header">
        <div class="header-text">
            <h2><i class="fas fa-edit mr-3"></i>Edit Vendor</h2>
        </div>
    </div>

    <div class="bento-tile shadow-lg">
        <form id="editVendorForm" action="{{ url_for('vendor.edit_vendor', code=vendor.vendor_code) }}" method="POST" autocomplete="off">
            <div class="form-group mb-4">
                <label class="small font-weight-bold text-muted uppercase ml-2">Vendor Code</label>
                <input type="text" name="code" id="code" class="form-control form-control-bento" 
                       value="{{ vendor.vendor_code }}" pattern="\d{6}" required>
                <div class="invalid-feedback ml-2" id="codeError">Please provide a valid 6-digit code.</div>
            </div>

            <div class="form-group mb-4">
                <label class="small font-weight-bold text-muted uppercase ml-2">Vendor Name</label>
                <input type="text" name="name" id="name" class="form-control form-control-bento" 
                       value="{{ vendor.vendor_name }}" required>
                <div class="invalid-feedback ml-2" id="nameError">Vendor name is required.</div>
            </div>

            <hr class="my-4 opacity-25">

            <div class="d-flex justify-content-between">
                <a href="{{ url_for('admin_management') }}" class="btn btn-light rounded-pill px-4 font-weight-bold text-muted">CANCEL</a>
                <button type="button" class="btn btn-save px-5 py-2" onclick="validateAndShowModal()">
                    <i class="fas fa-save mr-2"></i> Save Changes
                </button>
            </div>
        </form>
    </div>
</div>

<div class="modal fade modal-glass" id="confirmEditModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content modal-content-bento bento-tile shadow-2xl">
            <div class="text-center p-4">
                <i class="fas fa-exclamation-circle fa-4x text-info mb-4"></i>
                <h3 class="font-weight-bold mb-3">Save Changes?</h3>
                <p class="text-muted">Are you sure you want to update the records for this vendor?</p>
                <div class="d-flex justify-content-center mt-4">
                    <button type="button" class="btn btn-light rounded-pill px-4 mr-3" data-dismiss="modal">No, Cancel</button>
                    <button type="button" class="btn btn-primary rounded-pill px-4" onclick="submitForm()">Yes, Confirm</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // --- BROWSER CACHE & NAVIGATION FIX ---
    window.addEventListener('pageshow', function(event) {
        // Force a server reload if the page is loaded from the history (back/forward)
        // or if browser persistence is detected.
        const navEntries = performance.getEntriesByType("navigation");
        const isBackForward = navEntries.length > 0 && navEntries[0].type === 'back_forward';
        
        if (event.persisted || isBackForward) {
            window.location.reload(); 
        }
    });

    // Hard reset the form values back to original database state on every load
    window.onload = function() {
        document.getElementById('editVendorForm').reset();
    };

    function validateAndShowModal() {
        const codeInput = document.getElementById('code');
        const nameInput = document.getElementById('name');
        let isValid = true;

        [codeInput, nameInput].forEach(el => el.classList.remove('is-invalid'));

        if (!codeInput.checkValidity()) {
            codeInput.classList.add('is-invalid');
            isValid = false;
        }
        if (!nameInput.checkValidity()) {
            nameInput.classList.add('is-invalid');
            isValid = false;
        }

        if (isValid) {
            $('#confirmEditModal').modal('show');
        }
    }

    function submitForm() {
        document.getElementById('editVendorForm').submit();
    }
</script>
{% endblock %}