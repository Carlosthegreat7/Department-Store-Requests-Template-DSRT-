{% extends "base.html" %}

{% block content %}
<!-- Styles specific to Add modals to match add_vendor.html -->
<style>
    /* --- GLASSMOPHISM HEADER FOR MODALS --- */
    .glass-header-small {
        height: 100px;
        background: #4361ee;
        border-radius: 20px 20px 0 0;
        /* Top rounded only */
        position: relative;
        overflow: hidden;
        display: flex;
        align-items: center;
        padding: 0 30px;
        color: white;
        margin-bottom: 20px;
        box-shadow: 0 4px 15px rgba(67, 97, 238, 0.2);
    }

    .glass-header-small::before {
        content: "";
        position: absolute;
        inset: 0;
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        z-index: 1;
    }

    .header-text-small {
        z-index: 2;
    }

    .header-text-small h3 {
        font-weight: 800;
        letter-spacing: -0.5px;
        margin-bottom: 0;
        font-size: 1.5rem;
    }

    /* --- BENTO FORM CONTROLS --- */
    .form-control-bento {
        border-radius: 50px !important;
        padding: 12px 25px !important;
        border: 1px solid #e9ecef !important;
        background-color: #f8f9fa !important;
        color: #2d3436 !important;
        transition: all 0.3s ease;
        height: 50px;
    }

    .form-control-bento:focus {
        background-color: #fff !important;
        border-color: #4361ee !important;
        box-shadow: 0 0 0 0.2rem rgba(67, 97, 238, 0.15) !important;
    }

    .btn-save {
        background-image: linear-gradient(to right, #667eea, #764ba2, #6B8DD6, #8E37D7);
        background-size: 300% 100%;
        color: #fff !important;
        border: none;
        border-radius: 50px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 1px;
        transition: all 0.4s ease-in-out;
        box-shadow: 0 4px 15px 0 rgba(116, 79, 168, 0.45);
        padding: 12px 30px;
    }

    .btn-save:hover {
        background-position: 100% 0;
        transform: translateY(-2px);
    }

    .modal-content-bento {
        border-radius: 25px;
        border: none;
        overflow: hidden;
        /* For header radius */
    }
</style>

<div class="container mgmt-container">
    <div class="row mb-4">
        <div class="col-12">
            <h1 style="font-weight: 800; letter-spacing: -1px;">RDS Master Configuration</h1>
            <p class="text-muted">Maintain vendor codes, hierarchy mappings, price points, and age codes for RDS.</p>
        </div>
    </div>

    <div class="search-container">
        <div class="search-box">
            <i class="fas fa-search text-muted mr-3"></i>
            <input type="text" id="mgmtSearch" class="search-input" placeholder="Type to search RDS records...">
            <div style="height: 30px; width: 1px; background: #eee; margin: 0 15px;"></div>
            <select id="searchTarget" class="search-select">
                <option value="vendor">Vendors</option>
                <option value="hierarchy">Hierarchy</option>
                <option value="price">Price Points</option>
                <option value="age">Age Codes</option>
            </select>
        </div>
    </div>

    <ul class="nav nav-tabs mt-4" id="rdsTabs" role="tablist">
        <li class="nav-item"><a class="nav-link active" data-toggle="tab" href="#vendor" role="tab"
                onclick="syncDropdown(this)">Vendors</a></li>
        <li class="nav-item"><a class="nav-link" data-toggle="tab" href="#hierarchy" role="tab"
                onclick="syncDropdown(this)">Hierarchy</a></li>
        <li class="nav-item"><a class="nav-link" data-toggle="tab" href="#price" role="tab"
                onclick="syncDropdown(this)">Price Points</a></li>
        <li class="nav-item"><a class="nav-link" data-toggle="tab" href="#age" role="tab"
                onclick="syncDropdown(this)">Age Codes</a></li>
    </ul>

    <div class="tab-content tab-glass mb-5">
        <div class="tab-pane fade show active" id="vendor" role="tabpanel">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h5 class="font-weight-bold mb-0">RDS Vendors</h5>
                <button class="btn-bento-primary" data-toggle="modal" data-target="#addVendorRdsModal"
                    style="padding: 0 25px; height: 45px; font-size: 0.9rem;"><i class="fas fa-plus mr-2"></i> Add
                    Vendor</button>
            </div>
            <table class="table table-hover border-0" id="vendorTable">
                <thead class="small text-muted uppercase">
                    <tr>
                        <th class="sortable" onclick="sortTable(0, 'vendorTable')">Company Name</th>
                        <th class="sortable" onclick="sortTable(1, 'vendorTable')">Vendor Code</th>
                        <th class="sortable" onclick="sortTable(2, 'vendorTable')">Mfg Part No</th>
                        <th class="text-right">Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for v in vendors %}
                    <tr>
                        <td class="align-middle font-weight-bold">{{ v.company_name }}</td>
                        <td class="align-middle">{{ v.vendor_code }}</td>
                        <td class="align-middle">{{ v.mfg_part_no }}</td>
                        <td class="text-right">
                            <button class="btn-icon-hover edit border-0 mr-2"
                                onclick="openEditVendorModal('{{ v.id }}', '{{ v.company_name }}', '{{ v.vendor_code }}', '{{ v.mfg_part_no }}')"
                                title="Edit"><i class="fas fa-edit"></i></button>
                            <button class="btn-icon-hover delete border-0"
                                onclick="confirmDelete('vendor', '{{ v.id }}')" title="Delete"><i
                                    class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            <div id="vendorPagination" class="pagination-container"></div>
        </div>

        <div class="tab-pane fade" id="hierarchy" role="tabpanel">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h5 class="font-weight-bold mb-0">RDS Hierarchy</h5>
                <button class="btn-bento-primary" data-toggle="modal" data-target="#addHierarchyRdsModal"
                    style="padding: 0 25px; height: 45px; font-size: 0.9rem;"><i class="fas fa-plus mr-2"></i> Add
                    Hierarchy</button>
            </div>
            <table class="table table-hover border-0" id="hierarchyTable">
                <thead class="small text-muted uppercase">
                    <tr>
                        <th class="sortable" onclick="sortTable(0, 'hierarchyTable')">Dept</th>
                        <th class="sortable" onclick="sortTable(1, 'hierarchyTable')">Sub-Dept</th>
                        <th class="sortable" onclick="sortTable(2, 'hierarchyTable')">Class</th>
                        <th class="sortable" onclick="sortTable(3, 'hierarchyTable')">S-Class</th>
                        <th class="sortable" onclick="sortTable(4, 'hierarchyTable')">Name</th>
                        <th class="text-right">Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for h in hierarchies %}
                    <tr>
                        <td class="align-middle">{{ h.dept }}</td>
                        <td class="align-middle">{{ h.sdept }}</td>
                        <td class="align-middle">{{ h.class_code }}</td>
                        <td class="align-middle">{{ h.sclass }}</td>
                        <td class="align-middle font-weight-bold">{{ h.sclass_name }}</td>
                        <td class="text-right">
                            <button class="btn-icon-hover edit border-0 mr-2"
                                onclick="openEditHierarchyModal('{{ h.id }}', '{{ h.dept }}', '{{ h.sdept }}', '{{ h.class_code }}', '{{ h.sclass }}', '{{ h.sclass_name }}')"
                                title="Edit"><i class="fas fa-edit"></i></button>
                            <button class="btn-icon-hover delete border-0"
                                onclick="confirmDelete('hierarchy', '{{ h.id }}')" title="Delete"><i
                                    class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            <div id="hierarchyPagination" class="pagination-container"></div>
        </div>

        <div class="tab-pane fade" id="price" role="tabpanel">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h5 class="font-weight-bold mb-0">Price Points</h5>
                <button class="btn-bento-primary" data-toggle="modal" data-target="#addPricePointModal"
                    style="padding: 0 25px; height: 45px; font-size: 0.9rem;"><i class="fas fa-plus mr-2"></i> Add
                    Price Point</button>
            </div>
            <table class="table table-hover border-0" id="priceTable">
                <thead class="small text-muted uppercase">
                    <tr>
                        <th class="sortable" onclick="sortTable(0, 'priceTable')">Code</th>
                        <th class="sortable" onclick="sortTable(1, 'priceTable')">Description</th>
                        <th class="text-right">Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for p in price_points %}
                    <tr>
                        <td class="align-middle font-weight-bold">{{ p.price_point_code }}</td>
                        <td class="align-middle">{{ p.price_point_desc }}</td>
                        <td class="text-right">
                            <button class="btn-icon-hover edit border-0 mr-2"
                                onclick="openEditPricePointModal('{{ p.id }}', '{{ p.price_point_code }}', '{{ p.price_point_desc }}')"
                                title="Edit"><i class="fas fa-edit"></i></button>
                            <button class="btn-icon-hover delete border-0"
                                onclick="confirmDelete('price', '{{ p.id }}')" title="Delete"><i
                                    class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            <div id="pricePagination" class="pagination-container"></div>
        </div>

        <div class="tab-pane fade" id="age" role="tabpanel">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h5 class="font-weight-bold mb-0">Age Codes</h5>
                <button class="btn-bento-primary" data-toggle="modal" data-target="#addAgeCodeModal"
                    style="padding: 0 25px; height: 45px; font-size: 0.9rem;"><i class="fas fa-plus mr-2"></i> Add Age
                    Code</button>
            </div>
            <table class="table table-hover border-0" id="ageTable">
                <thead class="small text-muted uppercase">
                    <tr>
                        <th class="sortable" onclick="sortTable(0, 'ageTable')">Code</th>
                        <th class="sortable" onclick="sortTable(1, 'ageTable')">Description</th>
                        <th class="text-right">Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for a in age_codes %}
                    <tr>
                        <td class="align-middle font-weight-bold">{{ a.age_code }}</td>
                        <td class="align-middle">{{ a.description }}</td>
                        <td class="text-right">
                            <button class="btn-icon-hover delete border-0" onclick="confirmDelete('age', '{{ a.id }}')"
                                title="Delete"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            <div id="agePagination" class="pagination-container"></div>
        </div>
    </div>
</div>

<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="border-radius: 25px; border: none;">
            <div class="text-center p-4">
                <i class="fas fa-trash-alt fa-3x text-danger mb-3"></i>
                <h4 class="font-weight-bold">Delete RDS Record?</h4>
                <p class="text-muted">This action is permanent and may affect RDS standard mapping.</p>
                <form id="deleteForm" method="POST">
                    <button type="button" class="btn btn-light rounded-pill px-4 mr-2"
                        data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger rounded-pill px-4">Confirm Delete</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- ADD VENDOR RDS MODAL -->
<div class="modal fade" id="addVendorRdsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content modal-content-bento shadow-lg">

            <div class="glass-header-small">
                <div class="header-text-small">
                    <h3><i class="fas fa-plus-circle mr-3"></i>Add RDS Vendor</h3>
                </div>
            </div>

            <div class="px-5 pb-5">
                <form action="{{ url_for('rds_mng.add_vendor_rds') }}" method="POST" autocomplete="off">
                    <div class="row">
                        <div class="col-md-6 mb-4">
                            <label class="small font-weight-bold text-muted uppercase ml-2">Vendor Code</label>
                            <input type="text" name="vendor_code" class="form-control form-control-bento"
                                placeholder="e.g. 014353" required>
                        </div>
                        <div class="col-md-6 mb-4">
                            <label class="small font-weight-bold text-muted uppercase ml-2">Internal (Mfg) Part
                                No.</label>
                            <input type="text" name="mfg_part_no" class="form-control form-control-bento"
                                placeholder="e.g. MFG-999" required>
                        </div>
                    </div>

                    <div class="form-group mb-5">
                        <label class="small font-weight-bold text-muted uppercase ml-2">Company Name</label>
                        <input type="text" name="company_name" class="form-control form-control-bento"
                            placeholder="Full Company Name" required>
                    </div>

                    <div class="d-flex justify-content-end">
                        <button type="button" class="btn btn-light rounded-pill px-4 mr-3"
                            data-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-save">
                            <i class="fas fa-check-circle mr-2"></i> Save Vendor
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- EDIT VENDOR RDS MODAL -->
<div class="modal fade" id="editVendorRdsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content modal-content-bento shadow-lg">

            <div class="glass-header-small">
                <div class="header-text-small">
                    <h3><i class="fas fa-edit mr-3"></i>Edit RDS Vendor</h3>
                </div>
            </div>

            <div class="px-5 pb-5">
                <form id="editVendorRdsForm" method="POST" autocomplete="off">
                    <div class="row">
                        <div class="col-md-6 mb-4">
                            <label class="small font-weight-bold text-muted uppercase ml-2">Vendor Code</label>
                            <input type="text" name="vendor_code" id="edit_vendor_code"
                                class="form-control form-control-bento" required>
                        </div>
                        <div class="col-md-6 mb-4">
                            <label class="small font-weight-bold text-muted uppercase ml-2">Internal (Mfg) Part
                                No.</label>
                            <input type="text" name="mfg_part_no" id="edit_mfg_part_no"
                                class="form-control form-control-bento" required>
                        </div>
                    </div>

                    <div class="form-group mb-5">
                        <label class="small font-weight-bold text-muted uppercase ml-2">Company Name</label>
                        <input type="text" name="company_name" id="edit_company_name"
                            class="form-control form-control-bento" required>
                    </div>

                    <div class="d-flex justify-content-end">
                        <button type="button" class="btn btn-light rounded-pill px-4 mr-3"
                            data-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-save">
                            <i class="fas fa-save mr-2"></i> Save Changes
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- ADD HIERARCHY MODAL -->
<div class="modal fade" id="addHierarchyRdsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content modal-content-bento shadow-lg">
            <div class="glass-header-small">
                <div class="header-text-small">
                    <h3><i class="fas fa-plus-circle mr-3"></i>Add Hierarchy</h3>
                </div>
            </div>
            <div class="px-5 pb-5">
                <form action="{{ url_for('rds_mng.add_hierarchy_rds') }}" method="POST" autocomplete="off">
                    <div class="row">
                        <div class="col-md-6 mb-4">
                            <label class="small font-weight-bold text-muted uppercase ml-2">Dept</label>
                            <input type="text" name="dept" class="form-control form-control-bento" placeholder="e.g. 10"
                                required>
                        </div>
                        <div class="col-md-6 mb-4">
                            <label class="small font-weight-bold text-muted uppercase ml-2">Sub-Dept</label>
                            <input type="text" name="sdept" class="form-control form-control-bento"
                                placeholder="e.g. 20" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-4">
                            <label class="small font-weight-bold text-muted uppercase ml-2">Class</label>
                            <input type="text" name="class_code" class="form-control form-control-bento"
                                placeholder="e.g. 30" required>
                        </div>
                        <div class="col-md-6 mb-4">
                            <label class="small font-weight-bold text-muted uppercase ml-2">Sub-Class</label>
                            <input type="text" name="sclass" class="form-control form-control-bento"
                                placeholder="e.g. 40" required>
                        </div>
                    </div>
                    <div class="form-group mb-5">
                        <label class="small font-weight-bold text-muted uppercase ml-2">Sub-Class Name</label>
                        <input type="text" name="sclass_name" class="form-control form-control-bento"
                            placeholder="Description" required>
                    </div>
                    <div class="d-flex justify-content-end">
                        <button type="button" class="btn btn-light rounded-pill px-4 mr-3"
                            data-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-save"><i class="fas fa-check-circle mr-2"></i>
                            Save</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- EDIT HIERARCHY MODAL -->
<div class="modal fade" id="editHierarchyRdsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content modal-content-bento shadow-lg">
            <div class="glass-header-small">
                <div class="header-text-small">
                    <h3><i class="fas fa-edit mr-3"></i>Edit Hierarchy</h3>
                </div>
            </div>
            <div class="px-5 pb-5">
                <form id="editHierarchyRdsForm" method="POST" autocomplete="off">
                    <div class="row">
                        <div class="col-md-6 mb-4">
                            <label class="small font-weight-bold text-muted uppercase ml-2">Dept</label>
                            <input type="text" name="dept" id="edit_h_dept" class="form-control form-control-bento"
                                required>
                        </div>
                        <div class="col-md-6 mb-4">
                            <label class="small font-weight-bold text-muted uppercase ml-2">Sub-Dept</label>
                            <input type="text" name="sdept" id="edit_h_sdept" class="form-control form-control-bento"
                                required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-4">
                            <label class="small font-weight-bold text-muted uppercase ml-2">Class</label>
                            <input type="text" name="class_code" id="edit_h_class"
                                class="form-control form-control-bento" required>
                        </div>
                        <div class="col-md-6 mb-4">
                            <label class="small font-weight-bold text-muted uppercase ml-2">Sub-Class</label>
                            <input type="text" name="sclass" id="edit_h_sclass" class="form-control form-control-bento"
                                required>
                        </div>
                    </div>
                    <div class="form-group mb-5">
                        <label class="small font-weight-bold text-muted uppercase ml-2">Sub-Class Name</label>
                        <input type="text" name="sclass_name" id="edit_h_sclass_name"
                            class="form-control form-control-bento" required>
                    </div>
                    <div class="d-flex justify-content-end">
                        <button type="button" class="btn btn-light rounded-pill px-4 mr-3"
                            data-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-save"><i class="fas fa-save mr-2"></i> Update</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

</div>

<!-- ADD PRICE POINT MODAL -->
<div class="modal fade" id="addPricePointModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content modal-content-bento shadow-lg">
            <div class="glass-header-small">
                <div class="header-text-small">
                    <h3><i class="fas fa-plus-circle mr-3"></i>Add Price Point</h3>
                </div>
            </div>
            <div class="px-5 pb-5">
                <form action="{{ url_for('rds_mng.add_price_point_rds') }}" method="POST" autocomplete="off">
                    <div class="row">
                        <div class="col-md-4 mb-4">
                            <label class="small font-weight-bold text-muted uppercase ml-2">Code</label>
                            <input type="text" name="price_point_code" class="form-control form-control-bento"
                                placeholder="e.g. XX" required>
                        </div>
                        <div class="col-md-8 mb-4">
                            <label class="small font-weight-bold text-muted uppercase ml-2">Description</label>
                            <input type="text" name="price_point_desc" class="form-control form-control-bento"
                                placeholder="e.g. 1-1000" required>
                        </div>
                    </div>
                    <div class="d-flex justify-content-end">
                        <button type="button" class="btn btn-light rounded-pill px-4 mr-3"
                            data-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-save"><i class="fas fa-check-circle mr-2"></i>
                            Save</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- EDIT PRICE POINT MODAL -->
<div class="modal fade" id="editPricePointRdsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content modal-content-bento shadow-lg">
            <div class="glass-header-small">
                <div class="header-text-small">
                    <h3><i class="fas fa-edit mr-3"></i>Edit Price Point</h3>
                </div>
            </div>
            <div class="px-5 pb-5">
                <form id="editPricePointRdsForm" method="POST" autocomplete="off">
                    <div class="row">
                        <div class="col-md-4 mb-4">
                            <label class="small font-weight-bold text-muted uppercase ml-2">Code</label>
                            <input type="text" name="price_point_code" id="edit_price_point_code"
                                class="form-control form-control-bento" required>
                        </div>
                        <div class="col-md-8 mb-4">
                            <label class="small font-weight-bold text-muted uppercase ml-2">Description</label>
                            <input type="text" name="price_point_desc" id="edit_price_point_desc"
                                class="form-control form-control-bento" required>
                        </div>
                    </div>
                    <div class="d-flex justify-content-end">
                        <button type="button" class="btn btn-light rounded-pill px-4 mr-3"
                            data-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-save"><i class="fas fa-save mr-2"></i> Update</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Edit script tags removed: relying on base.html includes -->

<script>
    /**
     * PAGINATION & SEARCH LOGIC
     */
    const ROWS_PER_PAGE = 10;
    const tableStates = {
        vendor: { currentPage: 1 },
        hierarchy: { currentPage: 1 },
        price: { currentPage: 1 },
        age: { currentPage: 1 }
    };

    function paginateTable(type) {
        const table = document.getElementById(`${type}Table`);
        if (!table) return;

        const searchVal = document.getElementById('mgmtSearch').value.toLowerCase();
        let allRows = Array.from(table.querySelectorAll('tbody tr'));
        let visibleRows = allRows.filter(row => row.innerText.toLowerCase().includes(searchVal));

        const totalRows = visibleRows.length;
        const totalPages = Math.ceil(totalRows / ROWS_PER_PAGE);

        if (tableStates[type].currentPage > totalPages) tableStates[type].currentPage = 1;

        const start = (tableStates[type].currentPage - 1) * ROWS_PER_PAGE;
        const end = start + ROWS_PER_PAGE;

        allRows.forEach(row => row.style.display = 'none');
        visibleRows.slice(start, end).forEach(row => row.style.display = '');

        renderPaginationUI(type, totalPages, totalRows);
    }

    function renderPaginationUI(type, totalPages, totalRows) {
        const container = document.getElementById(`${type}Pagination`);
        let html = `<span class="small text-muted">Showing <b>${totalRows}</b> results</span><div>`;

        html += `<button class="page-btn" ${tableStates[type].currentPage === 1 ? 'disabled' : ''} 
                 onclick="changePage('${type}', ${tableStates[type].currentPage - 1})"><i class="fas fa-chevron-left"></i></button>`;

        for (let i = 1; i <= totalPages; i++) {
            if (i === 1 || i === totalPages || (i >= tableStates[type].currentPage - 1 && i <= tableStates[type].currentPage + 1)) {
                html += `<button class="page-btn ${tableStates[type].currentPage === i ? 'active' : ''}" 
                         onclick="changePage('${type}', ${i})">${i}</button>`;
            } else if (i === tableStates[type].currentPage - 2 || i === tableStates[type].currentPage + 2) {
                html += `<span class="text-muted mx-1">...</span>`;
            }
        }

        html += `<button class="page-btn" ${tableStates[type].currentPage === totalPages ? 'disabled' : ''} 
                 onclick="changePage('${type}', ${tableStates[type].currentPage + 1})"><i class="fas fa-chevron-right"></i></button>`;

        html += `</div>`;
        container.innerHTML = totalPages > 1 ? html : '';
    }

    window.changePage = function (type, page) {
        tableStates[type].currentPage = page;
        paginateTable(type);
        window.scrollTo({ top: $('.mgmt-container').offset().top - 100, behavior: 'smooth' });
    }

    // --- FINAL ROBUST SYNC LOGIC ---

    // Exposed function called directly by onclick in HTML
    window.syncDropdown = function (element) {
        // slight delay to ensure tab switch logic doesn't conflict
        setTimeout(() => {
            const href = element.getAttribute('href');
            if (href) {
                const targetId = href.replace('#', '');

                // Force update
                const dropdown = document.getElementById('searchTarget');
                if (dropdown) dropdown.value = targetId;

                paginateTable(targetId);

                // Update URL State
                if (history.pushState) {
                    history.pushState(null, null, '#' + targetId);
                }
            }
        }, 50);
    };

    $(document).ready(function () {
        // Initial pagination load
        ['vendor', 'hierarchy', 'price', 'age'].forEach(paginateTable);

        // SEARCH INPUT TRIGGER
        $('#mgmtSearch').on('input', function () {
            ['vendor', 'hierarchy', 'price', 'age'].forEach(type => {
                tableStates[type].currentPage = 1;
                paginateTable(type);
            });
        });

        // 2. Dropdown Change -> Update Tab
        $('#searchTarget').on('change', function () {
            const selectedTab = this.value;
            // Activate the tab
            $(`#rdsTabs a[href="#${selectedTab}"]`).tab('show');
            // Update table
            paginateTable(selectedTab);
        });

        // 3. Handle Hash on Load (Recover State)
        let hash = window.location.hash;
        if (hash) {
            const cleanHash = hash.replace('#', '');
            if ($(`#rdsTabs a[href="#${cleanHash}"]`).length) {
                $(`#rdsTabs a[href="#${cleanHash}"]`).tab('show');
                $('#searchTarget').val(cleanHash);
            }
        } else {
            // Sync initial state if no hash
            const activeLink = document.querySelector('#rdsTabs .nav-link.active');
            if (activeLink) {
                const activeId = activeLink.getAttribute('href').replace('#', '');
                $('#searchTarget').val(activeId);
            }
        }
    });

    /**
     * SORTING LOGIC
     */
    window.sortTable = function (n, tableId) {
        var table = document.getElementById(tableId);
        var rows, switching, i, x, y, shouldSwitch, dir, switchcount = 0;
        switching = true;
        dir = "asc";
        $(table).find('th').removeClass('sort-asc sort-desc');

        while (switching) {
            switching = false;
            rows = table.rows;
            for (i = 1; i < (rows.length - 1); i++) {
                shouldSwitch = false;
                x = rows[i].getElementsByTagName("TD")[n];
                y = rows[i + 1].getElementsByTagName("TD")[n];

                let xVal = x.innerText.toLowerCase();
                let yVal = y.innerText.toLowerCase();

                if (!isNaN(parseFloat(xVal)) && !isNaN(parseFloat(yVal))) {
                    xVal = parseFloat(xVal);
                    yVal = parseFloat(yVal);
                }

                if (dir == "asc") {
                    if (xVal > yVal) { shouldSwitch = true; break; }
                } else if (dir == "desc") {
                    if (xVal < yVal) { shouldSwitch = true; break; }
                }
            }
            if (shouldSwitch) {
                rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
                switching = true;
                switchcount++;
            } else {
                if (switchcount == 0 && dir == "asc") {
                    dir = "desc";
                    switching = true;
                }
            }
        }
        table.getElementsByTagName("TH")[n].classList.add(dir === "asc" ? "sort-asc" : "sort-desc");
        paginateTable(tableId.replace('Table', ''));
    }

    window.confirmDelete = function (type, id) {
        document.getElementById('deleteForm').action = `/admin/management/rds/delete-${type}/${id}`;
        $('#deleteConfirmModal').modal('show');
    }

    window.openEditVendorModal = function (id, name, code, mfg) {
        document.getElementById('edit_company_name').value = name;
        document.getElementById('edit_vendor_code').value = code;
        document.getElementById('edit_mfg_part_no').value = mfg;
        document.getElementById('editVendorRdsForm').action = `/admin/management/rds/edit_vendor/${id}`;
        $('#editVendorRdsModal').modal('show');
    }

    window.openEditHierarchyModal = function (id, dept, sdept, clss, sclss, name) {
        document.getElementById('edit_h_dept').value = dept;
        document.getElementById('edit_h_sdept').value = sdept;
        document.getElementById('edit_h_class').value = clss;
        document.getElementById('edit_h_sclass').value = sclss;
        document.getElementById('edit_h_sclass_name').value = name;
        document.getElementById('editHierarchyRdsForm').action = `/admin/management/rds/edit_hierarchy/${id}`;
        $('#editHierarchyRdsModal').modal('show');
    }

    window.openEditPricePointModal = function (id, code, desc) {
        document.getElementById('edit_price_point_code').value = code;
        document.getElementById('edit_price_point_desc').value = desc;
        document.getElementById('editPricePointRdsForm').action = `/admin/management/rds/edit_price_point/${id}`;
        $('#editPricePointRdsModal').modal('show');
    }


</script>
{% endblock %}