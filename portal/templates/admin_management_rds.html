{% extends "base.html" %}

{% block content %}
<!-- Styles moved to main.css -->

<div class="container mgmt-container">
    <div class="row mb-4">
        <div class="col-12">
            <h1 style="font-weight: 800; letter-spacing: -1px;">RDS Master Configuration</h1>
            <p class="text-muted">Maintain vendor codes, hierarchy mappings, price points, and age codes for RDS.</p>
        </div>
    </div>

    <div class="search-container">
        <div class="search-box">
            <i class="fas fa-search text-muted mr-3"></i>
            <input type="text" id="mgmtSearch" class="search-input" placeholder="Type to search RDS records...">
            <div style="height: 30px; width: 1px; background: #eee; margin: 0 15px;"></div>
            <select id="searchTarget" class="search-select">
                <option value="vendor">Vendors</option>
                <option value="hierarchy">Hierarchy</option>
                <option value="price">Price Points</option>
                <option value="age">Age Codes</option>
            </select>
        </div>
    </div>

    <ul class="nav nav-tabs mt-4" id="rdsTabs" role="tablist">
        <li class="nav-item"><a class="nav-link active" data-toggle="tab" href="#vendor" role="tab">Vendors</a></li>
        <li class="nav-item"><a class="nav-link" data-toggle="tab" href="#hierarchy" role="tab">Hierarchy</a></li>
        <li class="nav-item"><a class="nav-link" data-toggle="tab" href="#price" role="tab">Price Points</a></li>
        <li class="nav-item"><a class="nav-link" data-toggle="tab" href="#age" role="tab">Age Codes</a></li>
    </ul>

    <div class="tab-content tab-glass mb-5">
        <div class="tab-pane fade show active" id="vendor" role="tabpanel">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h5 class="font-weight-bold mb-0">RDS Vendors</h5>
                <button class="btn-bento-primary" data-toggle="modal" data-target="#addVendorRdsModal"
                    style="padding: 0 25px; height: 45px; font-size: 0.9rem;"><i class="fas fa-plus mr-2"></i> Add
                    Vendor</button>
            </div>
            <table class="table table-hover border-0" id="vendorTable">
                <thead class="small text-muted uppercase">
                    <tr>
                        <th class="sortable" onclick="sortTable(0, 'vendorTable')">Company Name</th>
                        <th class="sortable" onclick="sortTable(1, 'vendorTable')">Vendor Code</th>
                        <th class="sortable" onclick="sortTable(2, 'vendorTable')">Mfg Part No</th>
                        <th class="text-right">Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for v in vendors %}
                    <tr>
                        <td class="align-middle font-weight-bold">{{ v.company_name }}</td>
                        <td class="align-middle">{{ v.vendor_code }}</td>
                        <td class="align-middle">{{ v.mfg_part_no }}</td>
                        <td class="text-right">
                            <button class="btn-icon-hover delete border-0"
                                onclick="confirmDelete('vendor', '{{ v.id }}')" title="Delete"><i
                                    class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            <div id="vendorPagination" class="pagination-container"></div>
        </div>

        <div class="tab-pane fade" id="hierarchy" role="tabpanel">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h5 class="font-weight-bold mb-0">RDS Hierarchy</h5>
                <button class="btn-bento-primary" data-toggle="modal" data-target="#addHierarchyRdsModal"
                    style="padding: 0 25px; height: 45px; font-size: 0.9rem;"><i class="fas fa-plus mr-2"></i> Add
                    Hierarchy</button>
            </div>
            <table class="table table-hover border-0" id="hierarchyTable">
                <thead class="small text-muted uppercase">
                    <tr>
                        <th class="sortable" onclick="sortTable(0, 'hierarchyTable')">Dept</th>
                        <th class="sortable" onclick="sortTable(1, 'hierarchyTable')">Sub-Dept</th>
                        <th class="sortable" onclick="sortTable(2, 'hierarchyTable')">Class</th>
                        <th class="sortable" onclick="sortTable(3, 'hierarchyTable')">S-Class</th>
                        <th class="sortable" onclick="sortTable(4, 'hierarchyTable')">Name</th>
                        <th class="text-right">Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for h in hierarchies %}
                    <tr>
                        <td class="align-middle">{{ h.dept }}</td>
                        <td class="align-middle">{{ h.sdept }}</td>
                        <td class="align-middle">{{ h.class_code }}</td>
                        <td class="align-middle">{{ h.sclass }}</td>
                        <td class="align-middle font-weight-bold">{{ h.sclass_name }}</td>
                        <td class="text-right">
                            <button class="btn-icon-hover delete border-0"
                                onclick="confirmDelete('hierarchy', '{{ h.id }}')" title="Delete"><i
                                    class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            <div id="hierarchyPagination" class="pagination-container"></div>
        </div>

        <div class="tab-pane fade" id="price" role="tabpanel">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h5 class="font-weight-bold mb-0">Price Points</h5>
                <button class="btn-bento-primary" data-toggle="modal" data-target="#addPricePointModal"
                    style="padding: 0 25px; height: 45px; font-size: 0.9rem;"><i class="fas fa-plus mr-2"></i> Add
                    Price Point</button>
            </div>
            <table class="table table-hover border-0" id="priceTable">
                <thead class="small text-muted uppercase">
                    <tr>
                        <th class="sortable" onclick="sortTable(0, 'priceTable')">Code</th>
                        <th class="sortable" onclick="sortTable(1, 'priceTable')">Description</th>
                        <th class="text-right">Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for p in price_points %}
                    <tr>
                        <td class="align-middle font-weight-bold">{{ p.price_point_code }}</td>
                        <td class="align-middle">{{ p.price_point_desc }}</td>
                        <td class="text-right">
                            <button class="btn-icon-hover delete border-0"
                                onclick="confirmDelete('price', '{{ p.id }}')" title="Delete"><i
                                    class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            <div id="pricePagination" class="pagination-container"></div>
        </div>

        <div class="tab-pane fade" id="age" role="tabpanel">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h5 class="font-weight-bold mb-0">Age Codes</h5>
                <button class="btn-bento-primary" data-toggle="modal" data-target="#addAgeCodeModal"
                    style="padding: 0 25px; height: 45px; font-size: 0.9rem;"><i class="fas fa-plus mr-2"></i> Add Age
                    Code</button>
            </div>
            <table class="table table-hover border-0" id="ageTable">
                <thead class="small text-muted uppercase">
                    <tr>
                        <th class="sortable" onclick="sortTable(0, 'ageTable')">Code</th>
                        <th class="sortable" onclick="sortTable(1, 'ageTable')">Description</th>
                        <th class="text-right">Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for a in age_codes %}
                    <tr>
                        <td class="align-middle font-weight-bold">{{ a.age_code }}</td>
                        <td class="align-middle">{{ a.description }}</td>
                        <td class="text-right">
                            <button class="btn-icon-hover delete border-0" onclick="confirmDelete('age', '{{ a.id }}')"
                                title="Delete"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            <div id="agePagination" class="pagination-container"></div>
        </div>
    </div>
</div>

<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="border-radius: 25px; border: none;">
            <div class="text-center p-4">
                <i class="fas fa-trash-alt fa-3x text-danger mb-3"></i>
                <h4 class="font-weight-bold">Delete RDS Record?</h4>
                <p class="text-muted">This action is permanent and may affect RDS standard mapping.</p>
                <form id="deleteForm" method="POST">
                    <button type="button" class="btn btn-light rounded-pill px-4 mr-2"
                        data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger rounded-pill px-4">Confirm Delete</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
    /**
     * PAGINATION & SEARCH LOGIC
     */
    const ROWS_PER_PAGE = 10;
    const tableStates = {
        vendor: { currentPage: 1 },
        hierarchy: { currentPage: 1 },
        price: { currentPage: 1 },
        age: { currentPage: 1 }
    };

    function paginateTable(type) {
        const table = document.getElementById(`${type}Table`);
        if (!table) return;

        const searchVal = document.getElementById('mgmtSearch').value.toLowerCase();
        let allRows = Array.from(table.querySelectorAll('tbody tr'));
        let visibleRows = allRows.filter(row => row.innerText.toLowerCase().includes(searchVal));

        const totalRows = visibleRows.length;
        const totalPages = Math.ceil(totalRows / ROWS_PER_PAGE);

        if (tableStates[type].currentPage > totalPages) tableStates[type].currentPage = 1;

        const start = (tableStates[type].currentPage - 1) * ROWS_PER_PAGE;
        const end = start + ROWS_PER_PAGE;

        allRows.forEach(row => row.style.display = 'none');
        visibleRows.slice(start, end).forEach(row => row.style.display = '');

        renderPaginationUI(type, totalPages, totalRows);
    }

    function renderPaginationUI(type, totalPages, totalRows) {
        const container = document.getElementById(`${type}Pagination`);
        let html = `<span class="small text-muted">Showing <b>${totalRows}</b> results</span><div>`;

        html += `<button class="page-btn" ${tableStates[type].currentPage === 1 ? 'disabled' : ''} 
                 onclick="changePage('${type}', ${tableStates[type].currentPage - 1})"><i class="fas fa-chevron-left"></i></button>`;

        for (let i = 1; i <= totalPages; i++) {
            if (i === 1 || i === totalPages || (i >= tableStates[type].currentPage - 1 && i <= tableStates[type].currentPage + 1)) {
                html += `<button class="page-btn ${tableStates[type].currentPage === i ? 'active' : ''}" 
                         onclick="changePage('${type}', ${i})">${i}</button>`;
            } else if (i === tableStates[type].currentPage - 2 || i === tableStates[type].currentPage + 2) {
                html += `<span class="text-muted mx-1">...</span>`;
            }
        }

        html += `<button class="page-btn" ${tableStates[type].currentPage === totalPages ? 'disabled' : ''} 
                 onclick="changePage('${type}', ${tableStates[type].currentPage + 1})"><i class="fas fa-chevron-right"></i></button>`;

        html += `</div>`;
        container.innerHTML = totalPages > 1 ? html : '';
    }

    window.changePage = function (type, page) {
        tableStates[type].currentPage = page;
        paginateTable(type);
        window.scrollTo({ top: $('.mgmt-container').offset().top - 100, behavior: 'smooth' });
    }

    $(document).ready(function () {
        // Initial pagination load
        ['vendor', 'hierarchy', 'price', 'age'].forEach(paginateTable);

        // SEARCH INPUT TRIGGER
        $('#mgmtSearch').on('input', function () {
            ['vendor', 'hierarchy', 'price', 'age'].forEach(type => {
                tableStates[type].currentPage = 1;
                paginateTable(type);
            });
        });

        /**
         * UPDATED SYNC ENGINE (TAB -> DROPDOWN)
         */
        $(document).on('shown.bs.tab', 'a[data-toggle="tab"]', function (e) {
            // 1. Get the ID of the new active tab (e.g., #hierarchy)
            const targetId = $(e.target).attr("href").replace('#', '');

            // 2. Force the dropdown to select this value
            const dropdown = document.getElementById('searchTarget');
            if (dropdown) {
                dropdown.value = targetId;
            }

            // 3. Update table filtering for the current tab
            paginateTable(targetId);

            // 4. Preserve URL state
            window.history.replaceState(null, null, $(e.target).attr("href"));
        });

        /**
         * UPDATED SYNC ENGINE (DROPDOWN -> TAB)
         */
        $('#searchTarget').on('change', function () {
            const selectedTab = this.value;
            // Triggers the 'shown.bs.tab' event above automatically
            $(`#rdsTabs a[href="#${selectedTab}"]`).tab('show');
        });

        // RECOVER STATE FROM URL HASH
        let hash = window.location.hash;
        if (hash) {
            if ($(`.nav-tabs a[href="${hash}"]`).length) {
                $(`.nav-tabs a[href="${hash}"]`).tab('show');
                const dropdown = document.getElementById('searchTarget');
                if (dropdown) dropdown.value = hash.replace('#', '');
            }
        } else {
            // Set default on load
            const activeTab = $('#rdsTabs a.active').attr('href').replace('#', '');
            const dropdown = document.getElementById('searchTarget');
            if (dropdown) dropdown.value = activeTab;
        }
    });

    /**
     * SORTING LOGIC
     */
    window.sortTable = function (n, tableId) {
        var table = document.getElementById(tableId);
        var rows, switching, i, x, y, shouldSwitch, dir, switchcount = 0;
        switching = true;
        dir = "asc";
        $(table).find('th').removeClass('sort-asc sort-desc');

        while (switching) {
            switching = false;
            rows = table.rows;
            for (i = 1; i < (rows.length - 1); i++) {
                shouldSwitch = false;
                x = rows[i].getElementsByTagName("TD")[n];
                y = rows[i + 1].getElementsByTagName("TD")[n];

                let xVal = x.innerText.toLowerCase();
                let yVal = y.innerText.toLowerCase();

                if (!isNaN(parseFloat(xVal)) && !isNaN(parseFloat(yVal))) {
                    xVal = parseFloat(xVal);
                    yVal = parseFloat(yVal);
                }

                if (dir == "asc") {
                    if (xVal > yVal) { shouldSwitch = true; break; }
                } else if (dir == "desc") {
                    if (xVal < yVal) { shouldSwitch = true; break; }
                }
            }
            if (shouldSwitch) {
                rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
                switching = true;
                switchcount++;
            } else {
                if (switchcount == 0 && dir == "asc") {
                    dir = "desc";
                    switching = true;
                }
            }
        }
        table.getElementsByTagName("TH")[n].classList.add(dir === "asc" ? "sort-asc" : "sort-desc");
        paginateTable(tableId.replace('Table', ''));
    }

    window.confirmDelete = function (type, id) {
        document.getElementById('deleteForm').action = `/admin/management/rds/delete-${type}/${id}`;
        $('#deleteConfirmModal').modal('show');
    }
</script>
{% endblock %}